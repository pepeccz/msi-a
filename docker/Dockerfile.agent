# =============================================================================
# MSI Automotive - LangGraph Agent Service Dockerfile
# =============================================================================
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Install system dependencies for PostgreSQL, initialization scripts, and health checks
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    libpq-dev \
    gcc \
    libc6-dev \
    postgresql-client \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY agent/ ./agent/
COPY database/ ./database/
COPY shared/ ./shared/
COPY scripts/ ./scripts/

# Copy Alembic configuration and migrations
COPY alembic.ini ./alembic.ini

# Copy initialization scripts
COPY docker/init-db.sh ./docker/init-db.sh
COPY docker/entrypoint-agent.sh ./docker/entrypoint-agent.sh

# Make scripts executable
RUN chmod +x ./docker/init-db.sh ./docker/entrypoint-agent.sh

# Set entrypoint
ENTRYPOINT ["/app/docker/entrypoint-agent.sh"]

# Run agent worker
CMD ["python", "-m", "agent.main"]
